<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Para Veronica y Carbomci</title>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS GENERALES Y UI --- */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #ffe6ea;
            font-family: 'Quicksand', sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none; /* Safari */
            -webkit-tap-highlight-color: transparent;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        canvas {
            display: block;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        /* --- PANTALLAS (Men√∫s) --- */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(255, 240, 243, 0.98) 0%, rgba(255, 214, 224, 0.98) 100%);
            z-index: 20;
            transition: opacity 0.8s ease;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
            z-index: -1;
            display: none !important;
        }

        h1 {
            font-family: 'Great Vibes', cursive;
            color: #d63384;
            font-size: 3.5rem;
            margin: 0 0 20px 0;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.8);
        }

        h2 {
            font-family: 'Great Vibes', cursive;
            color: #ff4757;
            font-size: 2.8rem;
            margin-bottom: 20px;
        }

        p {
            color: #664d55;
            font-size: 1.1rem;
            max-width: 600px;
            line-height: 1.6;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.5);
            padding: 15px;
            border-radius: 15px;
        }

        /* --- BOTONES --- */
        .btn {
            background: linear-gradient(45deg, #ff6b81, #ff4757);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 50px;
            font-family: 'Quicksand', sans-serif;
            font-weight: bold;
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
            z-index: 100;
            position: relative;
        }

        .btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 10px rgba(255, 71, 87, 0.4);
        }
        
        .btn-ai {
            background: linear-gradient(45deg, #a55eea, #4b7bec);
            border: 2px solid rgba(255,255,255,0.5);
        }

        /* --- UI DE LA PROPUESTA --- */
        .buttons-container {
            position: relative;
            width: 100%;
            height: 300px; /* √Årea amplia para movimiento */
            display: flex;
            justify-content: center;
            align-items: center; /* Centrar el S√ç */
        }

        #btn-yes {
            background: linear-gradient(45deg, #2ed573, #7bed9f);
            z-index: 50; /* Z-index menor que el NO */
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 1.4rem;
            padding: 20px 45px;
            position: absolute; /* Fijo en el centro relativo */
        }

        #btn-no {
            background: linear-gradient(45deg, #ff4757, #ff6b81);
            position: absolute; 
            z-index: 100;
            /* Posici√≥n inicial al lado del s√≠ */
            transform: translateX(100px); 
            transition: top 0.2s ease-out, left 0.2s ease-out; /* Movimiento r√°pido pero suave */
        }

        /* --- MENSAJE DE GAME OVER --- */
        #game-over-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 25px 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            display: none;
            z-index: 30;
            border: 3px solid #ff6b81;
            width: 80%;
            max-width: 300px;
        }

        /* --- ELEMENTOS DECORATIVOS --- */
        .heart-particle {
            position: absolute;
            font-size: 24px;
            pointer-events: none;
            animation: floatUp 4s linear forwards;
            z-index: 50;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100vh) scale(1.5); opacity: 0; }
        }

        #tap-hint {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            color: rgba(102, 77, 85, 0.8);
            font-size: 1.1rem;
            font-weight: bold;
            animation: pulse 1.5s infinite;
            pointer-events: none;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 0.7; } }

        /* --- UI DEL FINAL (IA) --- */
        #ai-container {
            position: absolute;
            bottom: 20px;
            width: 90%;
            text-align: center;
            z-index: 40;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        #ai-result-box {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 5px;
            min-height: 50px;
            max-height: 120px;
            overflow-y: auto;
            border: 2px solid #ffd700;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-style: italic;
            color: #2c3e50;
            display: none;
            font-size: 0.95rem;
            width: 100%;
        }
        
        #final-message {
            margin-top: 10px;
            background: rgba(0,0,0,0.5);
            padding: 15px;
            border-radius: 10px;
            color: #fff;
            font-size: 0.95rem;
            line-height: 1.4;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .loading-dots:after {
            content: ' .';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
            40% { color: #333; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
            60% { text-shadow: .25em 0 0 #333, .5em 0 0 rgba(0,0,0,0);}
            80%, 100% { text-shadow: .25em 0 0 #333, .5em 0 0 #333;}
        }

    </style>
</head>
<body>

    <!-- AUDIO -->
    <audio id="bg-music" loop preload="auto">
        <source src="https://commondatastorage.googleapis.com/codeskulptor-assets/Epoq-Lepidoptera.ogg" type="audio/ogg">
    </audio>
    <audio id="win-music" preload="auto">
        <source src="https://commondatastorage.googleapis.com/codeskulptor-assets/week7-brrring.m4a" type="audio/mp4"> 
    </audio>

    <div id="game-container">
        
        <!-- PANTALLA 1: INICIO -->
        <div id="start-screen" class="screen">
            <h1>Hola Veronica ‚ù§Ô∏è</h1>
            <p>Carbomci tiene una misi√≥n muy importante y necesita tu ayuda para completarla.</p>
            <p>¬°El camino est√° lleno de peligros! ¬øPodr√°s guiarlo a salvo?</p>
            <p style="font-size: 0.9rem; background: none; padding: 0;">(Toca la pantalla para saltar)</p>
            <button class="btn" onclick="startGame()">¬°Comenzar Misi√≥n!</button>
        </div>

        <!-- CANVAS DEL JUEGO -->
        <canvas id="gameCanvas"></canvas>
        <div id="tap-hint" style="display:none;">¬°TOCA PARA SALTAR!</div>

        <!-- OVERLAY DE GAME OVER -->
        <div id="game-over-overlay">
            <h3 style="color: #ff4757; margin: 0 0 10px 0;">¬°Oh no! ü•∫</h3>
            <p style="margin: 0 0 15px 0; font-size: 1rem;">Carbomci choc√≥ con un obst√°culo.</p>
            <button class="btn" style="padding: 10px 30px; font-size: 1rem;" onclick="resetGame()">Intentar de nuevo</button>
        </div>

        <!-- PANTALLA 2: LA PROPUESTA -->
        <div id="proposal-screen" class="screen hidden">
            <h1>¬°Lo lograste! üéâ</h1>
            <p>Gracias a ti, Carbomci lleg√≥ sano y salvo a casa. Y ahora, √©l tiene una pregunta muy especial para ti...</p>
            <h2>¬øQuieres ser mi San Valent√≠n?</h2>
            
            <div class="buttons-container">
                <!-- Bot√≥n S√ç -->
                <button id="btn-yes" class="btn" onclick="acceptProposal()">¬°S√ç, ME ENCANTAR√çA! üòç</button>
                <!-- Bot√≥n NO -->
                <button id="btn-no" class="btn">Mmm... no s√© ü§î</button>
            </div>
        </div>

        <!-- PANTALLA 3: CENA ROM√ÅNTICA (CON IA) -->
        <div id="final-screen" class="screen hidden" style="padding: 0; background: #1e1e2e;">
            <canvas id="finalCanvas"></canvas>
            
            <div style="position: absolute; top: 4%; width: 100%; text-align: center; z-index: 30;">
                <h1 style="color: #fff; font-size: 2.5rem; text-shadow: 0 0 10px #ff6b81; margin-bottom: 5px;">¬°Feliz San Valent√≠n!</h1>
            </div>

            <!-- UI FLOTANTE PARA IA -->
            <div id="ai-container">
                
                <div id="final-message">
                    Me encanta como eres y me encanta estar contigo, porque este sea nuestro primer San Valent√≠n de muchos.<br>
                    <strong>Te quiero como no tienes idea ‚ù§Ô∏è</strong>
                </div>

                <div id="ai-result-box"></div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 10px;">
                    <button class="btn btn-ai" onclick="generateLoveLetter()">
                        ‚ú® Carta M√°gica
                    </button>
                    <button class="btn btn-ai" style="background: linear-gradient(45deg, #f0932b, #ffbe76);" onclick="generateDogThought()">
                        üêæ Carbomci opina
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIGURACI√ìN GEMINI API ---
        const apiKey = ""; // La clave se inyectar√° autom√°ticamente
        
        async function callGemini(prompt) {
            const displayBox = document.getElementById('ai-result-box');
            displayBox.style.display = 'block';
            displayBox.innerHTML = 'Conectando con las estrellas<span class="loading-dots"></span>';
            displayBox.scrollTop = 0; 
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const data = {
                contents: [{
                    parts: [{ text: prompt }]
                }]
            };

            const delays = [1000, 2000, 4000];
            for (let i = 0; i <= delays.length; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                    
                    const json = await response.json();
                    const text = json.candidates?.[0]?.content?.parts?.[0]?.text || "Las estrellas est√°n nubladas hoy, pero te quiero igual.";
                    
                    return text;
                } catch (error) {
                    if (i === delays.length) {
                        return "Hubo un peque√±o problema m√°gico. Pero recuerda: Te amo.";
                    }
                    await new Promise(resolve => setTimeout(resolve, delays[i]));
                }
            }
        }

        async function generateLoveLetter() {
            const prompt = "Escribe una carta de amor muy breve (m√°ximo 30 palabras), rom√°ntica y graciosa para Veronica de parte de Kevin. Estamos cenando en San Valent√≠n. Menciona lo guapa que est√° hoy y a nuestro perro Carbomci.";
            const text = await callGemini(prompt);
            const displayBox = document.getElementById('ai-result-box');
            displayBox.innerHTML = `<strong>üíå De Kevin:</strong><br>"${text}"`;
        }

        async function generateDogThought() {
            const prompt = "Act√∫a como Carbomci, un perrito negro y barbudo. Di una frase corta (m√°ximo 20 palabras) pidiendo comida de la mesa o comentando lo cursis que son mis due√±os Veronica y Kevin hoy.";
            const text = await callGemini(prompt);
            const displayBox = document.getElementById('ai-result-box');
            displayBox.innerHTML = `<strong>üê∂ Carbomci piensa:</strong><br>"${text}"`;
        }

        // --- CONFIGURACI√ìN JUEGO ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const finalCanvas = document.getElementById('finalCanvas');
        const finalCtx = finalCanvas.getContext('2d');
        
        let canvasWidth, canvasHeight;

        function resize() {
            canvasWidth = window.innerWidth;
            canvasHeight = window.innerHeight;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            finalCanvas.width = canvasWidth;
            finalCanvas.height = canvasHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // Estados
        let gameState = 'START'; 
        let frame = 0;
        let gameSpeed = 6; 
        let score = 0;
        const targetScore = 2000;

        // --- CARBOMCI ---
        const dog = {
            x: 50,
            y: 0,
            width: 55, 
            height: 50,
            vy: 0,
            gravity: 0.85, 
            jumpPower: -15, 
            isJumping: false,
            groundY: 0,
            
            draw: function() {
                const x = this.x;
                const y = this.y;
                const furColor = '#1a1a1a'; 
                const muzzleColor = '#2d2d2d'; 
                
                // Cuerpo
                ctx.fillStyle = furColor;
                ctx.beginPath();
                ctx.arc(x + 30, y + 30, 20, 0, Math.PI * 2); 
                ctx.arc(x + 15, y + 35, 15, 0, Math.PI * 2); 
                ctx.arc(x + 45, y + 25, 18, 0, Math.PI * 2); 
                ctx.fill();

                // Cabeza
                ctx.beginPath();
                ctx.arc(x + 45, y + 15, 20, 0, Math.PI * 2);
                ctx.fill();

                // Barba y Cejas Despeinadas
                ctx.strokeStyle = furColor;
                ctx.lineWidth = 2;
                ctx.beginPath();
                for(let i=0; i<10; i++) {
                    let randX = (Math.sin(i*30 + frame*0.1)) * 5;
                    ctx.moveTo(x + 40 + i*2, y + 25);
                    ctx.lineTo(x + 40 + i*2 + randX, y + 35);
                }
                ctx.stroke();

                // Orejas ca√≠das
                ctx.fillStyle = furColor;
                ctx.beginPath();
                ctx.ellipse(x + 28, y + 8, 8, 12, 0.8, 0, Math.PI * 2); 
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(x + 62, y + 8, 8, 12, -0.8, 0, Math.PI * 2); 
                ctx.fill();

                // Hocico Chato
                ctx.fillStyle = muzzleColor;
                ctx.beginPath();
                ctx.ellipse(x + 45, y + 20, 10, 7, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(x + 45, y + 18, 3.5, 0, Math.PI * 2);
                ctx.fill();

                // Ojos
                const eyeY = y + 12;
                ctx.fillStyle = '#fff';
                ctx.beginPath(); ctx.arc(x + 36, eyeY, 5, 0, Math.PI * 2); ctx.fill();
                ctx.beginPath(); ctx.arc(x + 54, eyeY, 5, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#3e2723'; 
                ctx.beginPath(); ctx.arc(x + 36, eyeY, 3.5, 0, Math.PI * 2);
                ctx.arc(x + 54, eyeY, 3.5, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#fff'; // Brillo
                ctx.beginPath(); ctx.arc(x + 34, eyeY - 1.5, 1.5, 0, Math.PI * 2);
                ctx.arc(x + 52, eyeY - 1.5, 1.5, 0, Math.PI * 2);
                ctx.fill();

                // Collar
                ctx.strokeStyle = '#d63031';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(x + 45, y + 28, 15, 0.3, Math.PI - 0.3);
                ctx.stroke();
                ctx.fillStyle = '#fdcb6e';
                ctx.beginPath(); ctx.arc(x + 45, y + 40, 4, 0, Math.PI*2); ctx.fill();

                // Patitas r√°pidas
                ctx.fillStyle = furColor;
                const legAnim = Math.sin(frame * 0.8) * 8; 
                ctx.beginPath(); ctx.arc(x + 20, y + 48 + legAnim, 7, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(x + 30, y + 48 - legAnim, 7, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(x + 50, y + 45 + legAnim, 7, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(x + 60, y + 45 - legAnim, 7, 0, Math.PI*2); ctx.fill();

                // Cola
                ctx.strokeStyle = furColor;
                ctx.lineWidth = 5;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(x + 15, y + 30);
                let tailWag = Math.sin(frame * 1.5) * 6;
                ctx.lineTo(x + 5, y + 20 + tailWag);
                ctx.stroke();
            },
            
            update: function() {
                this.y += this.vy;
                if (this.y + this.height < this.groundY) {
                    this.vy += this.gravity;
                    this.isJumping = true;
                } else {
                    this.vy = 0;
                    this.y = this.groundY - this.height;
                    this.isJumping = false;
                }
            },
            
            jump: function() {
                if (!this.isJumping) {
                    this.vy = this.jumpPower;
                }
            }
        };

        // --- OBST√ÅCULOS ---
        let obstacles = [];
        let clouds = [];
        let house = null;

        class Obstacle {
            constructor(type) {
                this.x = canvasWidth;
                this.type = type;
                this.markedForDeletion = false;
                
                // Configuraci√≥n de dificultad
                // AJUSTADO: Todos los obst√°culos se alinean con el suelo (groundY)
                if (type === 'spike') {
                    this.w = 50; this.h = 25;
                    this.y = dog.groundY - this.h;
                } else if (type === 'rock') {
                    this.w = 40; this.h = 40;
                    this.y = dog.groundY - this.h;
                } else if (type === 'enemyDog') {
                    this.w = 60; this.h = 50;
                    this.y = dog.groundY - this.h; 
                }
            }
            draw() {
                const x = this.x; const y = this.y; const w = this.w; const h = this.h;
                
                // Sombra para evitar que floten
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.beginPath(); ctx.ellipse(x + w/2, dog.groundY, w/2, 5, 0, 0, Math.PI*2); ctx.fill();

                if (this.type === 'spike') {
                    ctx.fillStyle = '#7f8c8d';
                    ctx.beginPath();
                    ctx.moveTo(x, y + h); ctx.lineTo(x + w/3, y); ctx.lineTo(x + 2*w/3, y + h);
                    ctx.moveTo(x + w/3, y + h); ctx.lineTo(x + 2*w/3, y); ctx.lineTo(x + w, y + h);
                    ctx.fill();
                } else if (this.type === 'rock') {
                    ctx.fillStyle = '#95a5a6';
                    ctx.beginPath();
                    ctx.moveTo(x, y+h); ctx.lineTo(x+10, y+10); ctx.lineTo(x+w-10, y); ctx.lineTo(x+w, y+h);
                    ctx.fill();
                } else if (this.type === 'enemyDog') {
                    const bodyColor = '#3d3d3d'; // Gris oscuro/negro
                    
                    // PERRO GUARDI√ÅN (Redise√±ado - Perfil cuadrado)
                    // Patas
                    ctx.fillStyle = bodyColor;
                    const legAnim = Math.sin(frame * 0.5) * 5;
                    ctx.fillRect(x + 5, y + 30 + legAnim, 8, 20); // Pata trasera
                    ctx.fillRect(x + 45, y + 30 - legAnim, 8, 20); // Pata delantera
                    
                    // Cuerpo (Rect√°ngulo redondeado)
                    ctx.beginPath();
                    ctx.roundRect(x, y + 15, w, 25, 5);
                    ctx.fill();

                    // Cabeza (Cuadrada con orejas)
                    ctx.fillRect(x - 5, y, 25, 25);
                    
                    // Orejas puntiagudas (Doberman style)
                    ctx.beginPath();
                    ctx.moveTo(x, y); ctx.lineTo(x+5, y-10); ctx.lineTo(x+10, y); // Oreja 1
                    ctx.moveTo(x+12, y); ctx.lineTo(x+17, y-10); ctx.lineTo(x+22, y); // Oreja 2
                    ctx.fill();

                    // Ojo rojo
                    ctx.fillStyle = '#e74c3c';
                    ctx.beginPath(); ctx.arc(x + 5, y + 10, 2, 0, Math.PI*2); ctx.fill();

                    // Collar de pinchos
                    ctx.strokeStyle = '#bdc3c7';
                    ctx.lineWidth = 3;
                    ctx.beginPath(); ctx.moveTo(x + 18, y + 18); ctx.lineTo(x + 18, y + 35); ctx.stroke();
                }
            }
            update() {
                this.x -= gameSpeed;
                if (this.x < -100) this.markedForDeletion = true;
            }
        }

        class House {
            constructor() {
                this.x = canvasWidth;
                this.y = dog.groundY - 140;
                this.w = 160;
                this.h = 140;
            }
            draw() {
                const x = this.x; const y = this.y;
                // Sombra casa
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.beginPath(); ctx.ellipse(x + 80, dog.groundY, 70, 10, 0, 0, Math.PI*2); ctx.fill();

                ctx.fillStyle = '#fce4ec'; ctx.fillRect(x, y + 50, 140, 90);
                ctx.fillStyle = '#ff7675'; 
                ctx.beginPath(); ctx.moveTo(x - 10, y + 50); ctx.lineTo(x + 70, y); ctx.lineTo(x + 150, y + 50); ctx.fill();
                ctx.fillStyle = '#6d4c41'; ctx.fillRect(x + 55, y + 80, 40, 60);
                ctx.fillStyle = '#ffd700'; ctx.beginPath(); ctx.arc(x + 85, y + 110, 3, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#555'; ctx.font = "18px Quicksand"; ctx.fillText("CASA", x + 55, y + 40);
            }
            update() { this.x -= gameSpeed; }
        }

        // --- L√ìGICA DE JUEGO ---
        function initGame() {
            frame = 0; score = 0; gameSpeed = 6; 
            obstacles = []; house = null;
            dog.x = 50; dog.vy = 0;
        }

        function checkCollision(rect1, rect2) {
            const dogBox = { x: rect1.x + 20, y: rect1.y + 20, w: rect1.width - 40, h: rect1.height - 25 };
            return (dogBox.x < rect2.x + rect2.w && dogBox.x + dogBox.w > rect2.x &&
                    dogBox.y < rect2.y + rect2.h && dogBox.y + dogBox.h > rect2.y);
        }

        function gameLoop() {
            if (gameState !== 'PLAYING' && gameState !== 'ARRIVED') return;

            ctx.clearRect(0, 0, canvasWidth, canvasHeight);

            // Fondo Cielo
            ctx.fillStyle = '#81ecec'; ctx.fillRect(0, 0, canvasWidth, canvasHeight);
            
            // Suelo (Menta Suave + Patr√≥n de Bloques)
            dog.groundY = canvasHeight - 100;
            ctx.fillStyle = '#a8e6cf'; // Base menta suave
            ctx.fillRect(0, dog.groundY, canvasWidth, 100);
            
            // Patr√≥n de "Velocidad" (Bloques de pasto m√°s oscuro - Estilo Cl√°sico)
            ctx.fillStyle = '#88d8b0'; // Menta un poco m√°s oscuro
            let offset = (frame * gameSpeed) % 80;
            for (let i = -80; i < canvasWidth + 80; i += 40) {
                // Dibujar bloques alternados para efecto de velocidad sin marear
                if ((i + offset) % 80 < 40) {
                    ctx.fillRect(i - offset, dog.groundY, 40, 100); 
                }
            }
            
            // Borde superior del pasto
            ctx.fillStyle = '#55efc4';
            ctx.fillRect(0, dog.groundY, canvasWidth, 10);


            // Nubes
            if (frame % 80 === 0) clouds.push({x: canvasWidth, y: Math.random()*(canvasHeight/3), s: Math.random()*2+1});
            clouds.forEach((c, i) => {
                c.x -= c.s;
                ctx.fillStyle = 'rgba(255,255,255,0.8)';
                ctx.beginPath(); ctx.arc(c.x, c.y, 25, 0, Math.PI*2); ctx.arc(c.x+20, c.y-10, 30, 0, Math.PI*2); ctx.arc(c.x+40, c.y, 25, 0, Math.PI*2); ctx.fill();
                if (c.x < -100) clouds.splice(i, 1);
            });

            if (gameState === 'PLAYING') {
                score++;
                if (score < targetScore - 400) { 
                    let spawnRate = Math.max(90, 150 - Math.floor(score/20)); 
                    if (frame % spawnRate === 0) {
                        const rand = Math.random();
                        let type = 'rock';
                        if (rand < 0.3) type = 'spike';
                        else if (rand < 0.6) type = 'enemyDog'; 
                        obstacles.push(new Obstacle(type));
                    }
                } else if (score >= targetScore && !house) {
                    house = new House();
                }
            }

            obstacles.forEach((ob, index) => {
                ob.update(); ob.draw();
                if (checkCollision(dog, ob)) gameOver();
                if (ob.markedForDeletion) obstacles.splice(index, 1);
            });

            if (house) {
                house.update(); house.draw();
                if (dog.x > house.x + 60) arrivedHome();
            }

            dog.update(); dog.draw();
            frame++;
            if (gameState === 'PLAYING' || gameState === 'ARRIVED') requestAnimationFrame(gameLoop);
        }

        // --- CONTROLES ---
        function jumpAction(e) {
            if (e && e.target && (e.target.closest('button') || e.target.classList.contains('btn'))) return;
            if (e && e.type === 'touchstart') e.preventDefault(); 
            if (gameState === 'PLAYING') dog.jump();
        }
        window.addEventListener('touchstart', jumpAction, {passive: false});
        window.addEventListener('mousedown', jumpAction);
        window.addEventListener('keydown', (e) => { if (e.code === 'Space' || e.code === 'ArrowUp') jumpAction(); });

        // --- GAME STATES ---
        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('tap-hint').style.display = 'block';
            gameState = 'PLAYING';
            initGame();
            gameLoop();
            
            const bgMusic = document.getElementById('bg-music');
            bgMusic.volume = 0.5;
            bgMusic.play().catch(() => console.log("Audio autoplay prevented"));
        }

        function gameOver() {
            gameState = 'GAMEOVER';
            document.getElementById('game-over-overlay').style.display = 'block';
        }

        function resetGame() {
            document.getElementById('game-over-overlay').style.display = 'none';
            gameState = 'PLAYING';
            initGame();
            gameLoop();
        }

        function arrivedHome() {
            gameState = 'ARRIVED'; gameSpeed = 0; 
            setTimeout(() => {
                const canvasEl = document.getElementById('gameCanvas');
                canvasEl.style.transition = "opacity 1s";
                canvasEl.style.opacity = "0";
                document.getElementById('tap-hint').style.display = 'none';
                setTimeout(() => {
                    canvasEl.style.display = 'none';
                    document.getElementById('proposal-screen').classList.remove('hidden');
                    resetNoButton();
                }, 1000);
            }, 800);
        }

        // --- L√ìGICA BOT√ìN "NO" ---
        const btnNo = document.getElementById('btn-no');
        const btnYes = document.getElementById('btn-yes');
        let scaleFactor = 1;

        function resetNoButton() {
            btnNo.style.position = 'absolute';
            btnNo.style.transform = 'translateX(100px)'; 
            btnNo.style.top = 'auto';
            btnNo.style.left = 'auto';
        }
        
        function moveNo(e) {
            if(e && e.cancelable) e.preventDefault();

            const btnYesRect = btnYes.getBoundingClientRect();
            const safeMargin = 20;
            const w = window.innerWidth - btnNo.offsetWidth - safeMargin;
            const h = window.innerHeight - btnNo.offsetHeight - safeMargin;

            let newX, newY;
            let overlap = true;
            let attempts = 0;

            while(overlap && attempts < 10) {
                newX = Math.random() * w + safeMargin/2;
                newY = Math.random() * h + safeMargin/2;
                
                if (newX < btnYesRect.right + 20 && newX + btnNo.offsetWidth > btnYesRect.left - 20 &&
                    newY < btnYesRect.bottom + 20 && newY + btnNo.offsetHeight > btnYesRect.top - 20) {
                    overlap = true;
                } else {
                    overlap = false;
                }
                attempts++;
            }

            btnNo.style.position = 'fixed'; 
            btnNo.style.transform = 'none';
            btnNo.style.left = newX + 'px';
            btnNo.style.top = newY + 'px';

            scaleFactor += 0.4;
            btnYes.style.transform = `scale(${scaleFactor})`;
        }

        btnNo.addEventListener('mouseover', moveNo);
        btnNo.addEventListener('touchstart', moveNo, {passive: false}); 
        btnNo.addEventListener('click', moveNo);

        function acceptProposal() {
            document.getElementById('proposal-screen').classList.add('hidden');
            document.getElementById('final-screen').classList.remove('hidden');
            
            const bgMusic = document.getElementById('bg-music');
            const winMusic = document.getElementById('win-music');
            bgMusic.pause(); bgMusic.currentTime = 0;
            winMusic.volume = 0.7;
            winMusic.play().catch(() => {}); 

            animateDinner();
            spawnHearts();
        }

        // --- ANIMACI√ìN FINAL ---
        let candleFrame = 0;

        function animateDinner() {
            const w = finalCanvas.width;
            const h = finalCanvas.height;
            finalCtx.clearRect(0,0,w,h);

            // Fondo
            finalCtx.fillStyle = '#2c3e50'; finalCtx.fillRect(0,0,w,h);
            
            // Ventana
            const wx = w/2 - 120; const wy = h/2 - 250; 
            finalCtx.fillStyle = '#0a0a20'; finalCtx.fillRect(wx, wy, 240, 200);
            if(Math.random()>0.9) { finalCtx.fillStyle='#fff'; finalCtx.fillRect(wx+Math.random()*240, wy+Math.random()*200, 2, 2); }
            finalCtx.fillStyle='#f1c40f'; finalCtx.beginPath(); finalCtx.arc(wx+180, wy+60, 25, 0, Math.PI*2); finalCtx.fill();
            finalCtx.strokeStyle='#7f8c8d'; finalCtx.lineWidth=8; finalCtx.strokeRect(wx, wy, 240, 200);
            finalCtx.beginPath(); finalCtx.moveTo(wx+120, wy); finalCtx.lineTo(wx+120, wy+200); finalCtx.moveTo(wx, wy+100); finalCtx.lineTo(wx+240, wy+100); finalCtx.stroke();

            // Mesa
            const tableY = h - 200; 
            finalCtx.fillStyle = '#c0392b'; finalCtx.fillRect(0, tableY, w, 200);
            
            // Vela
            const candleX = w/2; const candleY = tableY + 20;
            finalCtx.fillStyle = '#ecf0f1'; finalCtx.fillRect(candleX - 10, candleY - 60, 20, 60);
            candleFrame++;
            const flameH = 25 + Math.sin(candleFrame * 0.2) * 3;
            finalCtx.fillStyle = '#e67e22'; finalCtx.beginPath(); finalCtx.ellipse(candleX, candleY - 60 - (flameH/2), 8, flameH/2, 0, 0, Math.PI*2); finalCtx.fill();
            finalCtx.fillStyle = '#f1c40f'; finalCtx.beginPath(); finalCtx.ellipse(candleX, candleY - 60 - (flameH/2) + 5, 4, flameH/3, 0, 0, Math.PI*2); finalCtx.fill();
            
            const grad = finalCtx.createRadialGradient(candleX, candleY - 70, 10, candleX, candleY - 70, 180);
            grad.addColorStop(0, 'rgba(255, 234, 167, 0.2)'); grad.addColorStop(1, 'rgba(0,0,0,0)');
            finalCtx.fillStyle = grad; finalCtx.beginPath(); finalCtx.arc(candleX, candleY - 70, 180, 0, Math.PI*2); finalCtx.fill();

            // Copas
            drawWineGlass(w/2 - 50, tableY + 30);
            drawWineGlass(w/2 + 50, tableY + 30);

            // Pareja (Redise√±ada)
            drawSilhouette(w/2 - 120, tableY + 60, true);
            drawSilhouette(w/2 + 120, tableY + 60, false);

            requestAnimationFrame(animateDinner);
        }

        function drawSilhouette(x, y, isGirl) {
            const skinColor = '#d9a688'; 
            
            if (isGirl) {
                // VERONICA (Pelo largo, negro, elegante)
                finalCtx.fillStyle = '#111'; 
                finalCtx.beginPath(); finalCtx.ellipse(x, y + 50, 35, 55, 0, 0, Math.PI*2); finalCtx.fill(); 
                finalCtx.fillStyle = skinColor;
                finalCtx.beginPath(); finalCtx.arc(x, y, 30, 0, Math.PI*2); finalCtx.fill(); 
                finalCtx.fillStyle = '#0a0a0a';
                finalCtx.beginPath();
                finalCtx.arc(x, y - 5, 36, Math.PI, 0); 
                finalCtx.lineTo(x + 45, y + 80); 
                finalCtx.lineTo(x - 45, y + 80); 
                finalCtx.fill();
                // Collar de perlas (basado en foto)
                finalCtx.strokeStyle = '#fff'; finalCtx.lineWidth = 2;
                finalCtx.beginPath(); finalCtx.arc(x, y+25, 12, 0, Math.PI); finalCtx.stroke();

            } else {
                // KEVIN (Camisa clara, pelo corto, sonrisa)
                finalCtx.fillStyle = '#dbece8'; // Camisa clara
                finalCtx.beginPath(); finalCtx.ellipse(x, y + 50, 45, 55, 0, 0, Math.PI*2); finalCtx.fill();
                finalCtx.fillStyle = skinColor;
                finalCtx.beginPath(); finalCtx.arc(x, y, 32, 0, Math.PI*2); finalCtx.fill();
                finalCtx.fillStyle = '#1a1a1a'; // Pelo
                finalCtx.beginPath(); finalCtx.arc(x, y - 8, 34, 0.9*Math.PI, 2.1*Math.PI); finalCtx.fill();
                // Sonrisa
                finalCtx.fillStyle = '#fff';
                finalCtx.beginPath(); finalCtx.arc(x, y + 5, 10, 0.1, Math.PI - 0.1); finalCtx.fill();
            }
        }

        function drawWineGlass(x, y) {
            finalCtx.fillStyle='rgba(255,255,255,0.2)'; finalCtx.strokeStyle='#fff'; finalCtx.lineWidth=1;
            finalCtx.beginPath(); finalCtx.moveTo(x,y-40); finalCtx.lineTo(x,y); finalCtx.stroke();
            finalCtx.beginPath(); finalCtx.moveTo(x-12,y); finalCtx.lineTo(x+12,y); finalCtx.stroke();
            finalCtx.beginPath(); finalCtx.moveTo(x-15,y-60); finalCtx.bezierCurveTo(x-15,y-30,x+15,y-30,x+15,y-60); finalCtx.fill(); finalCtx.stroke();
            finalCtx.fillStyle='#720e1e';
            finalCtx.beginPath(); finalCtx.moveTo(x-13,y-45); finalCtx.bezierCurveTo(x-13,y-32,x+13,y-32,x+13,y-45); finalCtx.fill();
        }

        function spawnHearts() {
            setInterval(() => {
                const h = document.createElement('div');
                h.classList.add('heart-particle');
                h.innerHTML = Math.random()>0.5 ? '‚ù§Ô∏è' : '‚ú®';
                h.style.left = Math.random()*100 + 'vw';
                h.style.top = '100vh';
                document.body.appendChild(h);
                setTimeout(()=>h.remove(), 4000);
            }, 300);
        }
    </script>
</body>
</html>
